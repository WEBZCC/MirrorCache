{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Welcome to MirrorCache! \u00b6 MirrorCache is a Web Server for files download, which will route download requests to an appropriate mirror. MirrorCache doesn't store files and instead keeps in DB list of files from the Main Server . According to Wikipedia \"Cache - is a component that stores data so that future requests for that data can be served faster\". In this regard MirrorCache is a cache of (meta)information about geographical location of files. \"Cache hit\" means that MirrorCache was able to redirect to proper (the closest) mirror. \"Cache miss\" means that MirrorCache had to redirect request to the Main Server . Output below domonstrates a cache miss, so the download request will be redirected to the Main Server (in this case download.opensuse.org): > curl -I http://mirrorcache.opensuse.org/download/update/openSUSE-current/x86_64/alsa-1.1.5-lp152.8.6_lp152.9.4.1.x86_64.drpm HTTP/1.1 302 Found location: http://download.opensuse.org/update/openSUSE-current/x86_64/alsa-1.1.5-lp152.8.6_lp152.9.4.1.x86_64.drpm date: Wed, 29 Jul 2020 08:37:07 GMT Then background jobs will collect info about the hottest misses and scan predefined mirrors for presence of these files. Further requests will be redirected to one of the mirrors that has the file: > curl -I http://mirrorcache.opensuse.org/download/update/openSUSE-current/x86_64/alsa-1.1.5-lp152.8.6_lp152.9.4.1.x86_64.drpm HTTP/1.1 302 Found location: http://ftp.gwdg.de/pub/opensuse/update/openSUSE-current/x86_64/alsa-1.1.5-lp152.8.6_lp152.9.4.1.x86_64.drpm date: Wed, 29 Jul 2020 08:40:00 GMT The project was implemented as a quick hack with some amount of shortcuts to make things going. The goal is to improve it over time with the main focus to do the job. Motivation \u00b6 The motivation behind this project is to rethink architecture of mirrorbrain https://github.com/poeml/mirrorbrain with following features: - job queue; - web UI; - fileless approach means that application doesn't require physical access to managed files; - properly handle http/https and ipv4/ipv6 requests by picking a mirror which is able to serve that; - geo-cluster feature allows to configure an instance per region, where each instance scan only mirrors from own region. How to report issues or ask questions: \u00b6 Write an email to andrii.nikitin on domain suse.com or use the issue tracker at https://github.com/openSUSE/MirrorCache/","title":"Home"},{"location":"#welcome-to-mirrorcache","text":"MirrorCache is a Web Server for files download, which will route download requests to an appropriate mirror. MirrorCache doesn't store files and instead keeps in DB list of files from the Main Server . According to Wikipedia \"Cache - is a component that stores data so that future requests for that data can be served faster\". In this regard MirrorCache is a cache of (meta)information about geographical location of files. \"Cache hit\" means that MirrorCache was able to redirect to proper (the closest) mirror. \"Cache miss\" means that MirrorCache had to redirect request to the Main Server . Output below domonstrates a cache miss, so the download request will be redirected to the Main Server (in this case download.opensuse.org): > curl -I http://mirrorcache.opensuse.org/download/update/openSUSE-current/x86_64/alsa-1.1.5-lp152.8.6_lp152.9.4.1.x86_64.drpm HTTP/1.1 302 Found location: http://download.opensuse.org/update/openSUSE-current/x86_64/alsa-1.1.5-lp152.8.6_lp152.9.4.1.x86_64.drpm date: Wed, 29 Jul 2020 08:37:07 GMT Then background jobs will collect info about the hottest misses and scan predefined mirrors for presence of these files. Further requests will be redirected to one of the mirrors that has the file: > curl -I http://mirrorcache.opensuse.org/download/update/openSUSE-current/x86_64/alsa-1.1.5-lp152.8.6_lp152.9.4.1.x86_64.drpm HTTP/1.1 302 Found location: http://ftp.gwdg.de/pub/opensuse/update/openSUSE-current/x86_64/alsa-1.1.5-lp152.8.6_lp152.9.4.1.x86_64.drpm date: Wed, 29 Jul 2020 08:40:00 GMT The project was implemented as a quick hack with some amount of shortcuts to make things going. The goal is to improve it over time with the main focus to do the job.","title":"Welcome to MirrorCache!"},{"location":"#motivation","text":"The motivation behind this project is to rethink architecture of mirrorbrain https://github.com/poeml/mirrorbrain with following features: - job queue; - web UI; - fileless approach means that application doesn't require physical access to managed files; - properly handle http/https and ipv4/ipv6 requests by picking a mirror which is able to serve that; - geo-cluster feature allows to configure an instance per region, where each instance scan only mirrors from own region.","title":"Motivation"},{"location":"#how-to-report-issues-or-ask-questions","text":"Write an email to andrii.nikitin on domain suse.com or use the issue tracker at https://github.com/openSUSE/MirrorCache/","title":"How to report issues or ask questions:"},{"location":"flow/","text":"Overview and concept \u00b6 Here is the perfect place to provide a nice picture of the process...","title":"Overview and concept"},{"location":"flow/#overview-and-concept","text":"Here is the perfect place to provide a nice picture of the process...","title":"Overview and concept"},{"location":"mb_compare/","text":"MirrorCache (mc) concept vs MirrorBrain (mb) concept \u00b6 Scanning \u00b6 mb uses daily full scan of all files on all mirrors, without regard of whether files were ever downloaded or changed recently. This may be waste of resources. mc scans only those locations which are needed by users and prioritize the scans according to popularity. It may take up to 24 hours before mb notices that file has gone from a mirror. Clients will be incorrectly redirected and receive 404 error. mc is making sure that file exists on selected mirror and never redirects to locations where file was missing for a while. New files are added by scanners in mb, which needs careful handling of deadlocks when two scanners attempt to add the same files. mc has separate jobs for keeping in sync information about files on the Main Server and for scanning mirrors. In addition, jobs have natural locking mechanism (https://docs.mojolicious.org/Minion#lock), which prevents conflicting operations. New files are added by scanners in mb, which currently leads to many incorrect files in database. (Potentially overload of mb DB because of incorrectly configured mirror). (This may be fixed in cost of added coupling on mb architecture). Jobs queue \u00b6 mb relies on command line tool and cron to run jobs. User then manually reviews logs to find eventual problems (which is a challenge to do with current amount of logging). mc has a popular, mature, fast and asynchronous job queue: https://docs.mojolicious.org/Minion, which includes prioritization, rescheduling, custom job queues, scalability (adding workers), manageability (assigning workers to particular queues), dashboard, search, etc. WWW \u00b6 mb relies on rendering of static files generated by a cron job. mc uses the mojolicious.org framework, which has delayed rendering, javascript, etc. Fileless architecture \u00b6 Architecture By design mb uses local files for rendering directories in WebUI and for scanner jobs to detect files present on mirror. It is a complication for using several geographical instances of mb, so it's possible to configure Apache plugins with some periodical sync jobs to store empty files instead of keeping full content of files. mc is fileless by design, so it should be easy to spawn a new mc instance, which will become useful immediately. Since at the moment filename is not enough to identify the content of a file (see https://github.com/openSUSE/open-build-service/issues/6690), additional identification is required (e.g. filesize + mtime). This will complicate mb approach even more. (It will need to sync additional info besides empty files). Robustness \u00b6 While mc may lead to eventual increased traffic to the main server, both mc and mb must rely on robustness of the main server.","title":"MirrorCache vs MirrorBrain"},{"location":"mb_compare/#mirrorcache-mc-concept-vs-mirrorbrain-mb-concept","text":"","title":"MirrorCache (mc) concept vs MirrorBrain (mb) concept"},{"location":"mb_compare/#scanning","text":"mb uses daily full scan of all files on all mirrors, without regard of whether files were ever downloaded or changed recently. This may be waste of resources. mc scans only those locations which are needed by users and prioritize the scans according to popularity. It may take up to 24 hours before mb notices that file has gone from a mirror. Clients will be incorrectly redirected and receive 404 error. mc is making sure that file exists on selected mirror and never redirects to locations where file was missing for a while. New files are added by scanners in mb, which needs careful handling of deadlocks when two scanners attempt to add the same files. mc has separate jobs for keeping in sync information about files on the Main Server and for scanning mirrors. In addition, jobs have natural locking mechanism (https://docs.mojolicious.org/Minion#lock), which prevents conflicting operations. New files are added by scanners in mb, which currently leads to many incorrect files in database. (Potentially overload of mb DB because of incorrectly configured mirror). (This may be fixed in cost of added coupling on mb architecture).","title":"Scanning"},{"location":"mb_compare/#jobs-queue","text":"mb relies on command line tool and cron to run jobs. User then manually reviews logs to find eventual problems (which is a challenge to do with current amount of logging). mc has a popular, mature, fast and asynchronous job queue: https://docs.mojolicious.org/Minion, which includes prioritization, rescheduling, custom job queues, scalability (adding workers), manageability (assigning workers to particular queues), dashboard, search, etc.","title":"Jobs queue"},{"location":"mb_compare/#www","text":"mb relies on rendering of static files generated by a cron job. mc uses the mojolicious.org framework, which has delayed rendering, javascript, etc.","title":"WWW"},{"location":"mb_compare/#fileless-architecture","text":"Architecture By design mb uses local files for rendering directories in WebUI and for scanner jobs to detect files present on mirror. It is a complication for using several geographical instances of mb, so it's possible to configure Apache plugins with some periodical sync jobs to store empty files instead of keeping full content of files. mc is fileless by design, so it should be easy to spawn a new mc instance, which will become useful immediately. Since at the moment filename is not enough to identify the content of a file (see https://github.com/openSUSE/open-build-service/issues/6690), additional identification is required (e.g. filesize + mtime). This will complicate mb approach even more. (It will need to sync additional info besides empty files).","title":"Fileless architecture"},{"location":"mb_compare/#robustness","text":"While mc may lead to eventual increased traffic to the main server, both mc and mb must rely on robustness of the main server.","title":"Robustness"},{"location":"setup/","text":"Setup \u00b6 Common Setup \u00b6 Environment variables \u00b6 MirrorCache can be configured with following environment variables: MIRRORCACHE_ROOT (required): defines location of files, which needs redirection. It may be url, local folder or rsync address, e.g. MIRRORCACHE_ROOT=http://download.opensuse.org or MIRRORCACHE_ROOT=/srv/mirrorcache or MIRRORCACHE_ROOT=rsync://user:password@myhost.com/module . (Note that you must install additionally perl-Digest-MD4 if rsync url needs password verification). MIRRORCACHE_AUTH_URL (optional) may contain remote openid server url (default https://www.opensuse.org/openid/user/). if explicitly set to empty value - all login attempt will be allowed and user set to 'Demo'. MIRRORCACHE_TOP_FOLDERS (space separated values) may be set to automatically redirect /folder to /download/folder. For reference of using MOJO_LISTEN variable refer Mojolicious documentation, e.g. MOJO_LISTEN=http://*:8000 It is recommended to run MirrorCache daemon behind another streamline WebService, e.g. Apache or haproxy. Thus MOJO_REVERSE_PROXY=1 will be needed. MIRRORCACHE_REDIRECT is needed for use when MIRRORCACHE_ROOT is set to remote address. Requests will be redirected to this location when no mirror is found, e.g. MIRRORCACHE_REDIRECT=downloadcontent.opensuse.org MIRRORCACHE_METALINK_PUBLISHER may be set to customize publisher in metalink generation. MIRRORCACHE_METALINK_PUBLISHER_URL may be set to customize url of publisher in metalink generation. MIRRORCACHE_BRANDING loads files from templates/branding . Use the default folder as a base for your own branding and set this environment variable to the name of the newly created folder. MIRRORCACHE_VPN_PREFIX - MirrorCache will use column server.hostname_vpn for redirecting if client IP has prefix as defined by MIRRORCACHE_VPN_PREFIX. Without any database configuration MirrorCache will attempt to connect to database 'mirrorcache' on default PostgreSQL port 5432. Following variables can be used to configure database access: MIRRORCACHE_DBUSER (default empty) MIRRORCACHE_DBPASS (default empty) TEST_PG or MIRRORCACHE_DSN , e.g. MIRRORCACHE_DSN='DBI:Pg:dbname=mc_dev;host=/path/to/pg'` If neither TEST_PG nor MIRRORCACHE_DSN is defined, following variables are used: MIRRORCACHE_DB (default 'mirrorcache') MIRRORCACHE_DBHOST (default empty) MIRRORCACHE_DBPORT (default empty) GeoIP location \u00b6 If environment variable MIRRORCACHE_CITY_MMDB or MIRRORCACHE_IP2LOCATION is defined, the app will attempt to detect country of the request and find a mirror in the same country, e.g. MIRRORCACHE_CITY_MMDB=/var/lib/GeoIP/GeoLite2-City.mmdb or MIRRORCACHE_IP2LOCATION=/var/lib/GeoIP/IP2LOCATION-LITE-DB5.IPV6.BIN . See Maxmind or IP2Location website to obtain such file. Additional dependencies must be installed as well for GeoIP location to work: perl modules Mojolicious::Plugin::ClientIP and MaxMind::DB::Reader : # for Maxmind zypper in perl-Mojolicious-Plugin-ClientIP perl-MaxMind-DB-Reader # for IP2Location zypper in perl-Geo-IP2Location Types of install \u00b6 Install package \u00b6 An example for openSUSE zypper ar -f obs://openSUSE:infrastructure:MirrorCache MirrorCache zypper refresh -s zypper install MirrorCache zypper install postgresql postgresql-server systemctl enable postgresql sudo -u postgres createuser mirrorcache sudo -u postgres createdb mirrorcache # the services read environment variables from /etc/mirrorcache/conf.env by default echo \"MIRRORCACHE_ROOT=http://download.opensuse.org MIRRORCACHE_TOP_FOLDERS='debug distribution factory history ports repositories source tumbleweed update' MOJO_LISTEN=http://*:8000 \" >> /etc/mirrorcache/conf.env systemctl enable mirrorcache systemctl enable mirrorcache-backstage Setup systemd from source \u00b6 Install prerequisites. The project is based on Perl Mojolicious framework and set of Perl packages. The best way to install them is to reuse zypper and cpanm commands from CI environment: t/environ/lib/Dockerfile.environ You may skip installing MaxMind::DB::Reader and Mojolicious::Plugin::ClientIP if you don't need Geolocation detection, if you don't need MirrorCache to find a mirror in client's country. From now on it will be referenced as 'Geolocation feature'. You may need GeoIP database (optional, if 'Geolocation feature' is needed). /var/lib/GeoIP/GeoLite2-City.mmdb or /var/lib/GeoIP/IP2LOCATION-LITE-DB5.IPV6.BIN In such case you will also need following command in next step: # for MaxMind database echo MIRRORCACHE_CITY_MMDB = /var/lib/GeoIP/GeoLite2-City.mmdb >> /etc/mirrorcache/conf.env # or for IP2Location database echo MIRRORCACHE_IP2LOCATION = /var/lib/GeoIP/IP2LOCATION-LITE-DB5.IPV6.BIN >> /usr/share/mirrorcache/conf.env Setup Use following script as root for inspiration (see also t/systemd/01-smoke.t) # assume local PostgreSQL server is up and running with default config make install make setup_production_assets make setup_system_user make setup_system_db # the services read environment variables from /etc/mirrorcache/conf.env by default echo \"MIRRORCACHE_ROOT=http://download.opensuse.org MIRRORCACHE_TOP_FOLDERS='debug distribution factory history ports repositories source tumbleweed update' MOJO_LISTEN=http://*:8000 \" >> /etc/mirrorcache/conf.env systemctl enable mirrorcache systemctl enable mirrorcache-backstage # log into UI and provide admin rights to the user: sudo -u mirrorcache psql -c \"update acc set is_admin=1 where nickname='myusername'\" mirrorcache # add mirrors using UI or sql sudo -u mirrorcache psql -c \"insert into server(hostname,urldir,enabled,country,region) select 'mirror.aarnet.edu.au','/pub/opensuse/opensuse','t','au',''\" mirrorcache Development setup \u00b6 Install prerequisites. The project is based on Perl Mojolicious framework and set of Perl packages. The best way to install them is to reuse zypper and cpanm commands from CI environment: t/environ/lib/Dockerfile.environ You may skip installing MaxMind::DB::Reader and Mojolicious::Plugin::ClientIP if you don't need Geolocation detection, if you don't need MirrorCache to find a mirror in client's country. From now on it will be referenced as 'Geolocation feature'. You may need GeoIP database (optional, if 'Geolocation feature' is needed). /var/lib/GeoIP/GeoLite2-City.mmdb or /var/lib/GeoIP/IP2LOCATION-LITE-DB5.IPV6.BIN You will need PostgreSQL server running, create database for mirrorcache and create tables: createdb mc_dev psql -f sql/schema.sql mc_dev It is possible to run PostgreSQL on dedicated server as well. Example parameters to start WebApp: TEST_PG = 'DBI:Pg:dbname=mc_dev;host=/path/to/pg' \\ MIRRORCACHE_ROOT = http://download.opensuse.org \\ MIRRORCACHE_TOP_FOLDERS = 'debug distribution factory history ports repositories source tumbleweed update' \\ MIRRORCACHE_CITY_MMDB = /var/lib/GeoIP/GeoLite2-City.mmdb \\ # MIRRORCACHE_IP2LOCATION=/var/lib/GeoIP/IP2LOCATION-LITE-DB5.IPV6.BIN \\ MOJO_REVERSE_PROXY = 1 \\ MOJO_LISTEN = http://*:8000 \\ script/mirrorcache daemon To start background jobs: TEST_PG = 'DBI:Pg:dbname=mc_dev;host=/path/to/pg' \\ MIRRORCACHE_ROOT = http://download.opensuse.org \\ script/mirrorcache backstage run -j 16 Add mirrors using UI or sql, e.g.: insert into server ( hostname , urldir , enabled , country , region ) select 'mirror.aarnet.edu.au' , '/pub/opensuse/opensuse' , 't' , 'au' , '' ; insert into server ( hostname , urldir , enabled , country , region ) select 'ftp.iinet.net.au' , '/pub/opensuse' , 't' , 'au' , '' ; insert into server ( hostname , urldir , enabled , country , region ) select 'mirror.intergrid.com.au' , '/opensuse' , 't' , 'au' , '' ; insert into server ( hostname , urldir , enabled , country , region ) select 'mirror.internode.on.net' , '/pub/opensuse' , 't' , 'au' , '' ; insert into server ( hostname , urldir , enabled , country , region ) select 'ftp.netspace.net.au' , '/pub/opensuse' , 't' , 'au' , '' ; Log in using UI and add admin privilege to the user: update acc set is_admin = 1 where nickname = 'myusername' ; Development setup using environ framework \u00b6 environ framework provides a way to manage development setup of various products without root permissions. Such approach is useful in manual and integration testing, especially when various topologies are required. MirrorCache project uses environ framework in CI, e.g. to start several Apache instances, configure them as mirrors, try different scenarios: http/https redirection, one of mirrors is down, a file is gone from a mirror, etc. E.g. steps 2 - 7 above using environ framework. # Needs environ utility installed, as well templates for Apache, nginx, postgres, rsync git clone https://github.com/andrii-suse/environ sudo make -C environ install # First choose a slot to use in script, mc0 - mc9 are available, so several instances at the same time # here we will use slot 1 => mc1, first parameter is where MirrorCache sources are located mc = $( environ mc ~/github/MirrorCache ) # pg1-system2 will setup local instance of Postgres server with data directory in pg1-system2/dt/ $mc /gen_config MIRRORCACHE_ROOT = http://download.opensuse.org \\ MIRRORCACHE_TOP_FOLDERS = \"'debug distribution factory history ports repositories source tumbleweed update'\" \\ MIRRORCACHE_CITY_MMDB = /var/lib/GeoIP/GeoLite2-City.mmdb \\ # MIRRORCACHE_IP2LOCATION=/var/lib/GeoIP/IP2LOCATION-LITE-DB5.IPV6.BIN \\ MOJO_REVERSE_PROXY = 1 $mc /start $mc /backstage/start $mc /db/sql \"insert into server(hostname,urldir,enabled,country,region) select 'mirror.aarnet.edu.au','/pub/opensuse/opensuse','t','au',''\" # check status $mc /db/status $mc /backstage/status $mc /status Run tests from t/environ with docker, manually for debugging \u00b6 Note: Requires docker configured for non-root users MIRRORCACHE_CITY_MMDB adds this environment variable inside the container and mounts it as a volume if the file exists on the host EXPOSE_PORT maps whatever port you need from the container to host port 80 cd t/environ # Just run the test: ./01-smoke.sh # Run the test with your own MIRRORCACHE_CITY_MMDB MIRRORCACHE_CITY_MMDB=/var/lib/GeoIP/GeoLite2-City.mmdb ./01-smoke.sh # Run the test and keep the container, while mapping port 3110 to host port 80 EXPOSE_PORT=3110 ./01-smoke.sh To log in with a fake test-user, change $mc/start to MIRRORCACHE_TEST_TRUST_AUTH=1 $mc/start in your test Setting MIRRORCACHE_TEST_TRUST_AUTH to any number > 1 will result in current_user being undef , so no fake test-user login. You will only have access to some routes defined in lib/MirrorCache/WebAPI.pm . WARNING - Be careful when working inside container: 1. The source tree is mapped to the host, so any changes of source code inside container will be reflected on host and vice versa. 2. The container is removed automatically on next test start of the same test, so any modifications outside source tree will be lost. Don't forget to clean up the test containers when you're done :)","title":"Setup"},{"location":"setup/#setup","text":"","title":"Setup"},{"location":"setup/#common-setup","text":"","title":"Common Setup"},{"location":"setup/#environment-variables","text":"MirrorCache can be configured with following environment variables: MIRRORCACHE_ROOT (required): defines location of files, which needs redirection. It may be url, local folder or rsync address, e.g. MIRRORCACHE_ROOT=http://download.opensuse.org or MIRRORCACHE_ROOT=/srv/mirrorcache or MIRRORCACHE_ROOT=rsync://user:password@myhost.com/module . (Note that you must install additionally perl-Digest-MD4 if rsync url needs password verification). MIRRORCACHE_AUTH_URL (optional) may contain remote openid server url (default https://www.opensuse.org/openid/user/). if explicitly set to empty value - all login attempt will be allowed and user set to 'Demo'. MIRRORCACHE_TOP_FOLDERS (space separated values) may be set to automatically redirect /folder to /download/folder. For reference of using MOJO_LISTEN variable refer Mojolicious documentation, e.g. MOJO_LISTEN=http://*:8000 It is recommended to run MirrorCache daemon behind another streamline WebService, e.g. Apache or haproxy. Thus MOJO_REVERSE_PROXY=1 will be needed. MIRRORCACHE_REDIRECT is needed for use when MIRRORCACHE_ROOT is set to remote address. Requests will be redirected to this location when no mirror is found, e.g. MIRRORCACHE_REDIRECT=downloadcontent.opensuse.org MIRRORCACHE_METALINK_PUBLISHER may be set to customize publisher in metalink generation. MIRRORCACHE_METALINK_PUBLISHER_URL may be set to customize url of publisher in metalink generation. MIRRORCACHE_BRANDING loads files from templates/branding . Use the default folder as a base for your own branding and set this environment variable to the name of the newly created folder. MIRRORCACHE_VPN_PREFIX - MirrorCache will use column server.hostname_vpn for redirecting if client IP has prefix as defined by MIRRORCACHE_VPN_PREFIX. Without any database configuration MirrorCache will attempt to connect to database 'mirrorcache' on default PostgreSQL port 5432. Following variables can be used to configure database access: MIRRORCACHE_DBUSER (default empty) MIRRORCACHE_DBPASS (default empty) TEST_PG or MIRRORCACHE_DSN , e.g. MIRRORCACHE_DSN='DBI:Pg:dbname=mc_dev;host=/path/to/pg'` If neither TEST_PG nor MIRRORCACHE_DSN is defined, following variables are used: MIRRORCACHE_DB (default 'mirrorcache') MIRRORCACHE_DBHOST (default empty) MIRRORCACHE_DBPORT (default empty)","title":"Environment variables"},{"location":"setup/#geoip-location","text":"If environment variable MIRRORCACHE_CITY_MMDB or MIRRORCACHE_IP2LOCATION is defined, the app will attempt to detect country of the request and find a mirror in the same country, e.g. MIRRORCACHE_CITY_MMDB=/var/lib/GeoIP/GeoLite2-City.mmdb or MIRRORCACHE_IP2LOCATION=/var/lib/GeoIP/IP2LOCATION-LITE-DB5.IPV6.BIN . See Maxmind or IP2Location website to obtain such file. Additional dependencies must be installed as well for GeoIP location to work: perl modules Mojolicious::Plugin::ClientIP and MaxMind::DB::Reader : # for Maxmind zypper in perl-Mojolicious-Plugin-ClientIP perl-MaxMind-DB-Reader # for IP2Location zypper in perl-Geo-IP2Location","title":"GeoIP location"},{"location":"setup/#types-of-install","text":"","title":"Types of install"},{"location":"setup/#install-package","text":"An example for openSUSE zypper ar -f obs://openSUSE:infrastructure:MirrorCache MirrorCache zypper refresh -s zypper install MirrorCache zypper install postgresql postgresql-server systemctl enable postgresql sudo -u postgres createuser mirrorcache sudo -u postgres createdb mirrorcache # the services read environment variables from /etc/mirrorcache/conf.env by default echo \"MIRRORCACHE_ROOT=http://download.opensuse.org MIRRORCACHE_TOP_FOLDERS='debug distribution factory history ports repositories source tumbleweed update' MOJO_LISTEN=http://*:8000 \" >> /etc/mirrorcache/conf.env systemctl enable mirrorcache systemctl enable mirrorcache-backstage","title":"Install package"},{"location":"setup/#setup-systemd-from-source","text":"Install prerequisites. The project is based on Perl Mojolicious framework and set of Perl packages. The best way to install them is to reuse zypper and cpanm commands from CI environment: t/environ/lib/Dockerfile.environ You may skip installing MaxMind::DB::Reader and Mojolicious::Plugin::ClientIP if you don't need Geolocation detection, if you don't need MirrorCache to find a mirror in client's country. From now on it will be referenced as 'Geolocation feature'. You may need GeoIP database (optional, if 'Geolocation feature' is needed). /var/lib/GeoIP/GeoLite2-City.mmdb or /var/lib/GeoIP/IP2LOCATION-LITE-DB5.IPV6.BIN In such case you will also need following command in next step: # for MaxMind database echo MIRRORCACHE_CITY_MMDB = /var/lib/GeoIP/GeoLite2-City.mmdb >> /etc/mirrorcache/conf.env # or for IP2Location database echo MIRRORCACHE_IP2LOCATION = /var/lib/GeoIP/IP2LOCATION-LITE-DB5.IPV6.BIN >> /usr/share/mirrorcache/conf.env Setup Use following script as root for inspiration (see also t/systemd/01-smoke.t) # assume local PostgreSQL server is up and running with default config make install make setup_production_assets make setup_system_user make setup_system_db # the services read environment variables from /etc/mirrorcache/conf.env by default echo \"MIRRORCACHE_ROOT=http://download.opensuse.org MIRRORCACHE_TOP_FOLDERS='debug distribution factory history ports repositories source tumbleweed update' MOJO_LISTEN=http://*:8000 \" >> /etc/mirrorcache/conf.env systemctl enable mirrorcache systemctl enable mirrorcache-backstage # log into UI and provide admin rights to the user: sudo -u mirrorcache psql -c \"update acc set is_admin=1 where nickname='myusername'\" mirrorcache # add mirrors using UI or sql sudo -u mirrorcache psql -c \"insert into server(hostname,urldir,enabled,country,region) select 'mirror.aarnet.edu.au','/pub/opensuse/opensuse','t','au',''\" mirrorcache","title":"Setup systemd from source"},{"location":"setup/#development-setup","text":"Install prerequisites. The project is based on Perl Mojolicious framework and set of Perl packages. The best way to install them is to reuse zypper and cpanm commands from CI environment: t/environ/lib/Dockerfile.environ You may skip installing MaxMind::DB::Reader and Mojolicious::Plugin::ClientIP if you don't need Geolocation detection, if you don't need MirrorCache to find a mirror in client's country. From now on it will be referenced as 'Geolocation feature'. You may need GeoIP database (optional, if 'Geolocation feature' is needed). /var/lib/GeoIP/GeoLite2-City.mmdb or /var/lib/GeoIP/IP2LOCATION-LITE-DB5.IPV6.BIN You will need PostgreSQL server running, create database for mirrorcache and create tables: createdb mc_dev psql -f sql/schema.sql mc_dev It is possible to run PostgreSQL on dedicated server as well. Example parameters to start WebApp: TEST_PG = 'DBI:Pg:dbname=mc_dev;host=/path/to/pg' \\ MIRRORCACHE_ROOT = http://download.opensuse.org \\ MIRRORCACHE_TOP_FOLDERS = 'debug distribution factory history ports repositories source tumbleweed update' \\ MIRRORCACHE_CITY_MMDB = /var/lib/GeoIP/GeoLite2-City.mmdb \\ # MIRRORCACHE_IP2LOCATION=/var/lib/GeoIP/IP2LOCATION-LITE-DB5.IPV6.BIN \\ MOJO_REVERSE_PROXY = 1 \\ MOJO_LISTEN = http://*:8000 \\ script/mirrorcache daemon To start background jobs: TEST_PG = 'DBI:Pg:dbname=mc_dev;host=/path/to/pg' \\ MIRRORCACHE_ROOT = http://download.opensuse.org \\ script/mirrorcache backstage run -j 16 Add mirrors using UI or sql, e.g.: insert into server ( hostname , urldir , enabled , country , region ) select 'mirror.aarnet.edu.au' , '/pub/opensuse/opensuse' , 't' , 'au' , '' ; insert into server ( hostname , urldir , enabled , country , region ) select 'ftp.iinet.net.au' , '/pub/opensuse' , 't' , 'au' , '' ; insert into server ( hostname , urldir , enabled , country , region ) select 'mirror.intergrid.com.au' , '/opensuse' , 't' , 'au' , '' ; insert into server ( hostname , urldir , enabled , country , region ) select 'mirror.internode.on.net' , '/pub/opensuse' , 't' , 'au' , '' ; insert into server ( hostname , urldir , enabled , country , region ) select 'ftp.netspace.net.au' , '/pub/opensuse' , 't' , 'au' , '' ; Log in using UI and add admin privilege to the user: update acc set is_admin = 1 where nickname = 'myusername' ;","title":"Development setup"},{"location":"setup/#development-setup-using-environ-framework","text":"environ framework provides a way to manage development setup of various products without root permissions. Such approach is useful in manual and integration testing, especially when various topologies are required. MirrorCache project uses environ framework in CI, e.g. to start several Apache instances, configure them as mirrors, try different scenarios: http/https redirection, one of mirrors is down, a file is gone from a mirror, etc. E.g. steps 2 - 7 above using environ framework. # Needs environ utility installed, as well templates for Apache, nginx, postgres, rsync git clone https://github.com/andrii-suse/environ sudo make -C environ install # First choose a slot to use in script, mc0 - mc9 are available, so several instances at the same time # here we will use slot 1 => mc1, first parameter is where MirrorCache sources are located mc = $( environ mc ~/github/MirrorCache ) # pg1-system2 will setup local instance of Postgres server with data directory in pg1-system2/dt/ $mc /gen_config MIRRORCACHE_ROOT = http://download.opensuse.org \\ MIRRORCACHE_TOP_FOLDERS = \"'debug distribution factory history ports repositories source tumbleweed update'\" \\ MIRRORCACHE_CITY_MMDB = /var/lib/GeoIP/GeoLite2-City.mmdb \\ # MIRRORCACHE_IP2LOCATION=/var/lib/GeoIP/IP2LOCATION-LITE-DB5.IPV6.BIN \\ MOJO_REVERSE_PROXY = 1 $mc /start $mc /backstage/start $mc /db/sql \"insert into server(hostname,urldir,enabled,country,region) select 'mirror.aarnet.edu.au','/pub/opensuse/opensuse','t','au',''\" # check status $mc /db/status $mc /backstage/status $mc /status","title":"Development setup using environ framework"},{"location":"setup/#run-tests-from-tenviron-with-docker-manually-for-debugging","text":"Note: Requires docker configured for non-root users MIRRORCACHE_CITY_MMDB adds this environment variable inside the container and mounts it as a volume if the file exists on the host EXPOSE_PORT maps whatever port you need from the container to host port 80 cd t/environ # Just run the test: ./01-smoke.sh # Run the test with your own MIRRORCACHE_CITY_MMDB MIRRORCACHE_CITY_MMDB=/var/lib/GeoIP/GeoLite2-City.mmdb ./01-smoke.sh # Run the test and keep the container, while mapping port 3110 to host port 80 EXPOSE_PORT=3110 ./01-smoke.sh To log in with a fake test-user, change $mc/start to MIRRORCACHE_TEST_TRUST_AUTH=1 $mc/start in your test Setting MIRRORCACHE_TEST_TRUST_AUTH to any number > 1 will result in current_user being undef , so no fake test-user login. You will only have access to some routes defined in lib/MirrorCache/WebAPI.pm . WARNING - Be careful when working inside container: 1. The source tree is mapped to the host, so any changes of source code inside container will be reflected on host and vice versa. 2. The container is removed automatically on next test start of the same test, so any modifications outside source tree will be lost. Don't forget to clean up the test containers when you're done :)","title":"Run tests from t/environ with docker, manually for debugging"}]}